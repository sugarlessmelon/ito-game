<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ¨çº¿ ito - ç»ˆæç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root { --primary: #1d3557; --accent: #e63946; --bg: #f1faee; --card-bg: #fff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; text-align: center; padding: 10px; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; padding-bottom: 50px; }
        
        /* ç™»å½•ä¸é€šç”¨ */
        .hidden { display: none !important; }
        .btn { border: none; padding: 10px 15px; border-radius: 6px; font-size: 16px; cursor: pointer; color: white; transition: 0.2s; margin: 5px; }
        .btn-blue { background: #457b9d; }
        .btn-red { background: #e63946; }
        .btn-green { background: #2a9d8f; }
        .btn-gray { background: #6c757d; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        input { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }

        /* é¡¶éƒ¨æ  */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .user-info { font-size: 14px; color: #666; }

        /* é¢˜ç›® */
        .theme-box { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        #theme-display { font-size: 24px; font-weight: bold; color: var(--primary); margin: 10px 0; }

        /* è‡ªå·±çš„åŒºåŸŸ */
        .my-area { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-number { font-size: 72px; font-weight: 800; color: var(--accent); line-height: 1; margin: 10px 0; }
        .desc-input-group { display: flex; gap: 5px; justify-content: center; margin-top: 10px; }
        
        /* æ¡Œé¢åŒºåŸŸ (æ ¸å¿ƒ) */
        .table-area { min-height: 200px; background: #e9ecef; border-radius: 12px; padding: 20px; border: 2px dashed #cbd5e1; position: relative; }
        .table-area h3 { margin-top: 0; color: #6c757d; }
        
        /* å¡ç‰‡å®¹å™¨ (SortableJS ä½œç”¨äºæ­¤) */
        #card-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        
        /* å¡ç‰‡ 3D ç¿»è½¬æ•ˆæœ */
        .game-card {
            width: 100px; height: 140px;
            perspective: 1000px;
            cursor: grab;
            position: relative;
        }
        .game-card.dragging { opacity: 0.5; }
        
        .card-inner {
            position: relative;
            width: 100%; height: 100%;
            text-align: center;
            transition: transform 0.8s;
            transform-style: preserve-3d;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        /* ç¿»ç‰ŒçŠ¶æ€ */
        .game-card.flipped .card-inner { transform: rotateY(180deg); }
        .game-card.error .card-back { border: 4px solid #e63946; background: #fff0f0; } /* å¤±è´¥é«˜äº® */

        .card-front, .card-back {
            position: absolute;
            width: 100%; height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            padding: 5px; box-sizing: border-box;
            word-break: break-all;
        }

        /* æ­£é¢ (è¿˜æ²¡ç¿»å¼€æ—¶çœ‹åˆ°çš„) */
        .card-front { background: var(--primary); color: white; }
        .card-front .owner-name { font-size: 12px; opacity: 0.8; margin-bottom: 5px; }
        .card-front .card-desc { font-size: 14px; font-weight: bold; padding: 0 5px; }

        /* èƒŒé¢ (ç¿»å¼€åçœ‹åˆ°çš„æ•°å­—) */
        .card-back { background: white; color: var(--primary); transform: rotateY(180deg); border: 2px solid var(--primary); }
        .card-back .big-num { font-size: 40px; font-weight: bold; color: var(--accent); }
        .card-back small { font-size: 12px; color: #666; }

        /* æ¸¸æˆç»“æœå¼¹çª— */
        #result-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; }
        #result-text { font-size: 40px; font-weight: bold; margin-bottom: 20px; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media(max-width: 600px) {
            .game-card { width: 80px; height: 110px; }
            .card-front .card-desc { font-size: 12px; }
        }
    </style>
</head>
<body>

    <div id="login-screen" class="container">
        <h1>ito Online</h1>
        <div style="background: white; padding: 30px; border-radius: 12px;">
            <p>è¯·è¾“å…¥æ˜µç§°åŠ å…¥æ¸¸æˆ</p>
            <input type="text" id="username" placeholder="ä½ çš„æ˜µç§°" maxlength="10">
            <br><br>
            <button class="btn btn-blue" onclick="doLogin()">è¿›å…¥æˆ¿é—´</button>
        </div>
    </div>

    <div id="game-screen" class="container hidden">
        
        <div class="top-bar">
            <div class="user-info">ç©å®¶: <span id="my-name-display"></span></div>
            <button class="btn btn-gray" style="font-size:12px; padding:5px 10px;" onclick="doLogout()">é€€å‡º/æ¢å·</button>
        </div>

        <div class="theme-box">
            <small>å½“å‰ä¸»é¢˜</small>
            <div id="theme-display">...</div>
            <div id="theme-controls">
                <input type="text" id="theme-input" placeholder="è¾“å…¥æ–°é¢˜ç›®" style="width: 150px;">
                <button class="btn btn-blue" onclick="setTheme()">è®¾ç½®é¢˜ç›®</button>
            </div>
        </div>

        <div id="my-hand-area" class="my-area hidden">
            <div style="color: #666; font-size: 14px;">ä½ çš„æ•°å­— (ä»…è‡ªå·±å¯è§)</div>
            <div id="my-number" class="card-number">?</div>
            
            <div class="desc-input-group" id="input-group">
                <input type="text" id="my-desc-input" placeholder="è¾“å…¥æè¿° (å¦‚: è‹¹æœ)" maxlength="15">
                <button class="btn btn-green" onclick="confirmDesc()">ç¡®å®š</button>
            </div>
            <div id="desc-display-group" class="hidden" style="margin-top:10px;">
                <span style="font-size:18px; font-weight:bold; color: #1d3557;">æè¿°: <span id="my-desc-text"></span></span>
                <button class="btn btn-red" style="padding: 5px 10px; font-size: 12px;" onclick="withdrawDesc()">æ’¤å›ä¿®æ”¹</button>
            </div>

            <div style="margin-top: 20px;">
                <button id="btn-play" class="btn btn-blue" style="width: 100%; padding: 15px; font-size: 18px;" onclick="playCard()" disabled>æŠŠç‰Œæ‰“å…¥æ¡Œé¢</button>
                <button id="btn-takeback" class="btn btn-gray hidden" style="width: 100%; margin-top:5px;" onclick="takeBackCard()">ä»æ¡Œé¢æ”¶å›</button>
            </div>
        </div>

        <div class="table-area">
            <h3>æ¡Œé¢ (æ‹–æ‹½å¡ç‰‡è°ƒæ•´é¡ºåº)</h3>
            <div id="card-list">
                </div>
        </div>

        <div style="margin-top: 30px; border-top: 1px solid #ddd; padding-top: 20px;">
            <p id="status-text" style="color:#666; margin-bottom:10px;">ç­‰å¾…æ“ä½œ...</p>
            <div style="display: flex; justify-content: center; gap: 10px;">
                <button class="btn btn-green" onclick="socket.emit('startGame')">é‡æ–°å‘ç‰Œ/ä¸‹ä¸€å±€</button>
                <button class="btn btn-red" onclick="revealCards()">ğŸ‘‘ å¼€ç‰Œç»“ç®—</button>
            </div>
            <br>
            <button class="btn btn-gray" onclick="socket.emit('resetGame')">é‡ç½®ä¸€åˆ‡</button>
        </div>
        
        <div style="margin-top: 20px; font-size: 12px; color: #999;">
            åœ¨çº¿ç©å®¶: <span id="player-list-span"></span>
        </div>
    </div>

    <div id="result-overlay" class="hidden" onclick="this.classList.add('hidden')">
        <div id="result-text">æˆåŠŸ!</div>
        <p>ç‚¹å‡»ä»»æ„å¤„å…³é—­</p>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myUid = localStorage.getItem('ito_uid');
        let myName = localStorage.getItem('ito_name');
        let currentDesc = "";
        let isMyCardPlayed = false;
        let sortableInstance = null;

        // --- åˆå§‹åŒ–ä¸ç™»å½• ---
        
        // è‡ªåŠ¨ç™»å½•å°è¯•
        if (myUid && myName) {
            document.getElementById('username').value = myName;
            doLogin();
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function doLogin() {
            const nameInput = document.getElementById('username').value.trim();
            if (!nameInput) return alert("è¯·è¾“å…¥åå­—");
            
            if (!myUid) {
                myUid = generateUUID();
                localStorage.setItem('ito_uid', myUid);
            }
            myName = nameInput;
            localStorage.setItem('ito_name', myName);

            socket.emit('login', { uid: myUid, name: myName });
        }

        function doLogout() {
            localStorage.removeItem('ito_uid');
            localStorage.removeItem('ito_name');
            location.reload();
        }

        // --- Socket äº‹ä»¶ç›‘å¬ ---

        socket.on('loginSuccess', (player) => {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('my-name-display').textContent = player.name;
            
            // æ¢å¤çŠ¶æ€
            if (player.card) {
                document.getElementById('my-hand-area').classList.remove('hidden');
                document.getElementById('my-number').textContent = player.card;
                if (player.desc) {
                    document.getElementById('my-desc-input').value = player.desc;
                    confirmDesc(false); // æ¢å¤ç•Œé¢æ˜¾ç¤ºä½†ä¸é‡å¤å‘åŒ…
                }
            }
        });

        socket.on('updateTheme', (t) => {
            document.getElementById('theme-display').textContent = t;
        });

        socket.on('gameStarted', () => {
            document.getElementById('my-hand-area').classList.remove('hidden');
            document.getElementById('status-text').textContent = "æ¸¸æˆå¼€å§‹ï¼è¯·æ€è€ƒå¹¶å¡«å†™æè¿°ã€‚";
            resetMyUI();
        });

        socket.on('yourCard', (data) => {
            document.getElementById('my-number').textContent = data.number;
        });

        socket.on('updatePlayerList', (list) => {
            document.getElementById('player-list-span').textContent = list.map(p => p.name).join(', ');
        });

        // æ ¸å¿ƒï¼šæ›´æ–°æ¡Œé¢å¡ç‰‡
        socket.on('updateTable', (cards) => {
            renderTable(cards);
        });
        
        socket.on('playerPlayed', (uid) => {
            if (uid === myUid) {
                isMyCardPlayed = true;
                updatePlayButtonState();
            }
        });

        socket.on('playerTakenBack', (uid) => {
            if (uid === myUid) {
                isMyCardPlayed = false;
                updatePlayButtonState();
            }
        });

        // ç»“ç®—
        socket.on('gameResult', (data) => {
            // å…ˆæ¸²æŸ“å¸¦æ•°å­—çš„ç‰Œï¼ˆç¿»é¢ï¼‰
            renderTable(data.tableCards, true, data.failedIndices);
            
            // å»¶è¿Ÿä¸€ç‚¹æ˜¾ç¤ºå¤§å­—ç»“æœ
            setTimeout(() => {
                const overlay = document.getElementById('result-overlay');
                const text = document.getElementById('result-text');
                overlay.classList.remove('hidden');
                
                if (data.isSuccess) {
                    text.textContent = "ğŸ‰ æŒ‘æˆ˜æˆåŠŸ!";
                    text.style.color = "#4cc9f0";
                } else {
                    text.textContent = "ğŸ’€ æŒ‘æˆ˜å¤±è´¥";
                    text.style.color = "#e63946";
                }
            }, 800);
        });

        socket.on('resetGame', () => {
            document.getElementById('my-hand-area').classList.add('hidden');
            document.getElementById('card-list').innerHTML = '';
            document.getElementById('theme-display').textContent = "ç­‰å¾…è®¾ç½®...";
            resetMyUI();
        });

        // --- äº¤äº’é€»è¾‘å‡½æ•° ---

        function setTheme() {
            const val = document.getElementById('theme-input').value;
            if(val) socket.emit('updateTheme', val);
        }

        // ç¡®è®¤æè¿°
        function confirmDesc(emit = true) {
            const val = document.getElementById('my-desc-input').value.trim();
            if (!val) return alert("è¯·è¾“å…¥æè¿°");
            
            currentDesc = val;
            
            // UIåˆ‡æ¢
            document.getElementById('input-group').classList.add('hidden');
            document.getElementById('desc-display-group').classList.remove('hidden');
            document.getElementById('my-desc-text').textContent = currentDesc;
            document.getElementById('btn-play').disabled = false; // å…è®¸å‡ºç‰Œ
            
            if (emit) socket.emit('updateDesc', { uid: myUid, desc: currentDesc });
        }

        // æ’¤å›æè¿°
        function withdrawDesc() {
            if (isMyCardPlayed) return alert("è¯·å…ˆä»æ¡Œé¢æ”¶å›å¡ç‰Œå†ä¿®æ”¹æè¿°");
            
            document.getElementById('input-group').classList.remove('hidden');
            document.getElementById('desc-display-group').classList.add('hidden');
            document.getElementById('btn-play').disabled = true;
        }

        function playCard() {
            if (!currentDesc) return;
            socket.emit('playCard', { uid: myUid });
        }
        
        function takeBackCard() {
            socket.emit('takeBackCard', { uid: myUid });
        }

        function revealCards() {
            if(confirm("ç¡®å®šæ‰€æœ‰äººéƒ½å‡ºå®Œå¹¶æ’å¥½åºäº†å—ï¼Ÿ")) {
                socket.emit('revealCards');
            }
        }

        function updatePlayButtonState() {
            const btnPlay = document.getElementById('btn-play');
            const btnTake = document.getElementById('btn-takeback');
            
            if (isMyCardPlayed) {
                btnPlay.classList.add('hidden');
                btnTake.classList.remove('hidden');
            } else {
                btnPlay.classList.remove('hidden');
                btnTake.classList.add('hidden');
                btnPlay.disabled = !currentDesc; // å¦‚æœæ²¡æè¿°ï¼Œè¿˜æ˜¯ç¦ç”¨çš„
            }
        }

        function resetMyUI() {
            document.getElementById('my-desc-input').value = "";
            currentDesc = "";
            isMyCardPlayed = false;
            document.getElementById('input-group').classList.remove('hidden');
            document.getElementById('desc-display-group').classList.add('hidden');
            document.getElementById('btn-play').disabled = true;
            document.getElementById('btn-play').classList.remove('hidden');
            document.getElementById('btn-takeback').classList.add('hidden');
        }

        // --- æ¸²æŸ“æ¡Œé¢ä¸æ‹–æ‹½ ---

        function renderTable(cards, isRevealed = false, failedIndices = []) {
            const list = document.getElementById('card-list');
            list.innerHTML = '';

            cards.forEach((c, index) => {
                const el = document.createElement('div');
                el.className = `game-card ${isRevealed ? 'flipped' : ''}`;
                if (failedIndices.includes(index)) el.classList.add('error');
                
                el.setAttribute('data-uid', c.uid); // ç”¨äºæ’åºè¯†åˆ«

                // æ­£é¢ (æ˜¾ç¤ºæè¿°)
                const front = document.createElement('div');
                front.className = 'card-front';
                front.innerHTML = `
                    <div class="owner-name">${c.name}</div>
                    <div class="card-desc">${c.desc || '...'}</div>
                `;

                // èƒŒé¢ (æ˜¾ç¤ºæ•°å­—)
                const back = document.createElement('div');
                back.className = 'card-back';
                back.innerHTML = `
                    <small>${c.name}</small>
                    <div class="big-num">${c.number}</div>
                    <div style="font-size:10px; margin-top:5px;">${c.desc}</div>
                `;

                const inner = document.createElement('div');
                inner.className = 'card-inner';
                inner.appendChild(front);
                inner.appendChild(back);
                el.appendChild(inner);

                list.appendChild(el);
            });

            // åˆå§‹åŒ–æ‹–æ‹½ (åªåœ¨æ²¡ç¿»ç‰Œå‰å…è®¸)
            if (!isRevealed) {
                if (!sortableInstance) {
                    sortableInstance = new Sortable(list, {
                        animation: 150,
                        ghostClass: 'dragging',
                        onEnd: function (evt) {
                            // è·å–æ–°çš„é¡ºåº
                            const newOrder = [];
                            const items = list.querySelectorAll('.game-card');
                            items.forEach(item => newOrder.push(item.getAttribute('data-uid')));
                            
                            // å‘é€ç»™æœåŠ¡å™¨
                            socket.emit('reorderCards', newOrder);
                        }
                    });
                } else {
                    // å¦‚æœå·²ç»æœ‰å®ä¾‹ï¼Œåªè¦ç¡®ä¿å®ƒæ˜¯enableçš„
                    sortableInstance.option("disabled", false);
                }
            } else {
                // ç¿»ç‰Œåç¦æ­¢æ‹–æ‹½
                if (sortableInstance) sortableInstance.option("disabled", true);
            }
        }

    </script>
</body>
</html>
