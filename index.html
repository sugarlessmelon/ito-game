<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤§ä¸‰ç´¢æ•´æ´»ä¿±ä¹éƒ¨ä¹‹ç³»/å‘½æ‚¬ä¸€çº¿/ito</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root { --primary: #1d3557; --accent: #e63946; --bg: #f0f2f5; --card-bg: #fff; --line-color: #a8dadc; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); text-align: center; margin: 0; padding-bottom: 20px; }
        .container { max-width: 900px; margin: 0 auto; padding: 10px; }
        .hidden { display: none !important; }
        .btn { border: none; padding: 10px 15px; border-radius: 6px; font-size: 16px; cursor: pointer; color: white; transition: 0.2s; margin: 5px; touch-action: manipulation; }
        .btn-blue { background: #457b9d; }
        .btn-red { background: #e63946; }
        .btn-green { background: #2a9d8f; }
        .btn-gray { background: #6c757d; }
        .btn-purple { background: #6d597a; } 
        .btn:disabled { opacity: 0.5; cursor: not-allowed; background: #999; }
        input { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }

        #modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 3000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-box {
            background: white; width: 80%; max-width: 400px;
            padding: 20px; border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: scale(0.9); transition: transform 0.3s;
        }
        #modal-overlay.show .modal-box { transform: scale(1); }
        .modal-title { font-size: 20px; font-weight: bold; color: var(--primary); margin-bottom: 10px; }
        .modal-body { font-size: 16px; color: #333; margin-bottom: 20px; line-height: 1.5; }
        .modal-input { width: 90%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; }
        .modal-btns { display: flex; justify-content: flex-end; gap: 10px; }

        .game-layout { display: flex; gap: 20px; align-items: flex-start; }
        .main-content { flex: 1; width: 100%; }
        
        .sidebar { width: 250px; flex-shrink: 0; display: flex; flex-direction: column; gap: 20px; }
        .player-box { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left; font-size: 14px; max-height: 400px; overflow-y: auto; }
        .player-box h4 { margin: 0 0 10px 0; color: var(--primary); font-size: 16px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .player-item { padding: 5px 0; color: #555; border-bottom: 1px solid #f0f0f0; }
        .player-item.is-me { color: var(--accent); font-weight: bold; }
        .player-item.done { color: #2a9d8f; }
        .player-item.offline { color: #ccc; text-decoration: line-through; }

        /* æ¡Œé¢ç«¯èŠå¤©æ¡†é»˜è®¤æ ·å¼ */
        #chat-container { 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            padding: 10px; 
            display: flex; 
            flex-direction: column; 
            height: 300px; 
        }
        #chat-messages { 
            flex: 1; /* æ¡Œé¢ç«¯è‡ªåŠ¨å¡«å……å‰©ä½™ç©ºé—´ */
            overflow-y: auto; 
            border: 1px solid #eee; 
            margin-bottom: 10px; 
            padding: 5px; 
            text-align: left; 
            background: #f9f9f9; 
            border-radius: 6px; 
            font-size: 14px; 
        }
        .chat-line { margin-bottom: 4px; border-bottom: 1px solid #eee; padding-bottom: 2px;}
        .chat-line .name { font-weight: bold; color: #457b9d; }
        .chat-controls { display: flex; gap: 5px; }
        #chat-input { flex-grow: 1; width: 50%; } 

        /* èŠå¤©æ¡†å¤´éƒ¨ (é»˜è®¤éšè—ï¼Œä»…æ‰‹æœºç«¯æ˜¾ç¤º) */
        #chat-header { display: none; }

        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 10px 15px; border-radius: 8px; }
        .theme-box { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; position: relative; }
        #theme-display { font-size: 24px; font-weight: bold; color: var(--primary); margin: 10px 0; word-wrap: break-word; }
        #theme-controls { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; }
        
        .my-area { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; transition: 0.3s; }
        .card-number { font-size: 72px; font-weight: 800; color: var(--accent); line-height: 1; margin: 10px 0; }
        
        .table-area { min-height: 250px; background: #e9ecef; border-radius: 12px; padding: 20px; border: 2px dashed #cbd5e1; position: relative; }
        
        .direction-line {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; font-weight: bold; color: #1d3557; opacity: 0.7;
            border-bottom: 4px dotted #a8dadc; padding-bottom: 5px;
        }
        .direction-line span { font-size: 14px; background: #e9ecef; padding: 0 10px; transform: translateY(14px); }

        #card-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; }
        
        .game-card { width: 100px; height: 140px; perspective: 1000px; position: relative; touch-action: none; } 
        .game-card.can-drag { cursor: grab; }
        .game-card.can-drag:active { cursor: grabbing; }
        .game-card.dragging { opacity: 0.5; }
        .game-card.is-mine .card-back, .game-card.is-mine .card-front { border: 3px solid #ffca3a; box-shadow: 0 0 15px rgba(255, 202, 58, 0.6); z-index: 10; }

        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s; transform-style: preserve-3d; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .game-card.flipped .card-inner { transform: rotateY(180deg); }
        .game-card.error .card-back { border: 4px solid #e63946; background: #fff0f0; }

        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 8px; padding: 5px; box-sizing: border-box; word-break: break-all; }
        .card-front { background: var(--primary); color: white; }
        .card-front .owner-name { font-size: 12px; opacity: 0.8; margin-bottom: 5px; }
        .card-front .card-desc { font-size: 14px; font-weight: bold; padding: 0 5px; }
        .card-back { background: white; color: var(--primary); transform: rotateY(180deg); border: 2px solid var(--primary); }
        .card-back .big-num { font-size: 40px; font-weight: bold; color: var(--accent); }
        .card-back small { font-size: 12px; color: #666; }

        #result-bar { margin-top: 15px; padding: 15px; border-radius: 8px; font-size: 18px; font-weight: bold; display: none; }
        .result-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .result-fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        #spectator-overlay { padding: 20px; background: #fff3cd; color: #856404; border: 1px solid #ffeeba; border-radius: 8px; margin-bottom: 20px; display: none; }

        #toast-notification {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(42, 157, 143, 0.95); color: white;
            padding: 12px 24px; border-radius: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 2000;
            opacity: 0; transition: opacity 0.5s ease; pointer-events: none;
            font-weight: bold; font-size: 16px;
        }
        #toast-notification.show { opacity: 1; }

        .mode-selector { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .mode-item { padding: 8px 12px; border: 1px solid #ccc; border-radius: 20px; font-size: 14px; cursor: pointer; background: #f9f9f9; color: #666; }
        .mode-item.selected { background: #457b9d; color: white; border-color: #457b9d; font-weight: bold; }
        .mode-item.disabled { opacity: 0.5; cursor: not-allowed; background: #eee; }

        h1.main-title { color: #e63946; margin-bottom: 20px; font-size: 24px; line-height: 1.4; }

        /* --- ç§»åŠ¨ç«¯é€‚é… (é‡å†™èŠå¤©æ¡†é€»è¾‘) --- */
        @media(max-width: 600px) {
            body { padding-bottom: 220px; }
            .game-layout { flex-direction: column; } 
            .sidebar { width: 100%; gap: 10px; }
            .player-box { max-height: 100px; }
            .player-item { display: inline-block; margin-right: 10px; }
            
            /* æ‰‹æœºç«¯èŠå¤©æ¡† */
            #chat-container { 
                position: fixed; 
                bottom: 0; left: 0; right: 0; 
                z-index: 99; 
                height: auto; /* å®¹å™¨é«˜åº¦ç”±å­å…ƒç´ å†³å®š */
                border-radius: 12px 12px 0 0; 
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
                transition: transform 0.3s ease;
                display: flex;
                flex-direction: column;
                padding: 0; 
            }
            
            /* å¤´éƒ¨å¼€å…³æ  */
            #chat-header {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 30px;
                background: #e9ecef;
                border-radius: 12px 12px 0 0;
                color: #666;
                font-size: 12px;
                cursor: pointer;
                border-bottom: 1px solid #ddd;
                flex-shrink: 0;
            }

            /* æ¶ˆæ¯åŒºåŸŸï¼šå…³é”®ä¿®å¤ */
            #chat-messages { 
                flex: none; /* å…³é”®ï¼šç¦æ­¢å¼¹æ€§ä¼¸ç¼©ï¼Œå¼ºåˆ¶éµå®ˆheight */
                height: 200px; /* å›ºå®šé«˜åº¦ï¼šçº¦7-8è¡Œ */
                margin: 0;
                border: none;
                border-radius: 0;
                overflow-y: auto; /* ç¡®ä¿å†…å®¹å¤šæ—¶å¯æ»šåŠ¨ */
            }
            
            /* è¾“å…¥æ¡†åŒºåŸŸ */
            .chat-controls {
                padding: 10px;
                background: white;
            }

            /* æŠ˜å çŠ¶æ€ */
            #chat-container.collapsed {
                /* å‘ä¸‹å¹³ç§»ï¼Œåªä¿ç•™å¤´éƒ¨30pxå¯è§ */
                transform: translateY(calc(100% - 30px));
            }

            .game-card { width: 80px; height: 110px; }
            .card-front .card-desc { font-size: 12px; }
            h1.main-title { font-size: 20px; }
        }
        @media(min-width: 601px) { h1.main-title { font-size: 32px; } }
    </style>
</head>
<body>
    <div id="modal-overlay">
        <div class="modal-box">
            <div id="modal-title" class="modal-title">æç¤º</div>
            <div id="modal-body" class="modal-body">å†…å®¹</div>
            <input type="text" id="modal-input" class="modal-input hidden" placeholder="">
            <div class="modal-btns">
                <button id="modal-btn-cancel" class="btn btn-gray hidden">å–æ¶ˆ</button>
                <button id="modal-btn-confirm" class="btn btn-blue">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div id="toast-notification">æœ¬è½®æ¸¸æˆä¸»é¢˜å·²æ›´æ–°ï¼</div>

    <div id="login-screen" class="container">
        <h1 class="main-title">å¤§ä¸‰ç´¢æ•´æ´»ä¿±ä¹éƒ¨ä¹‹ç³»/å‘½æ‚¬ä¸€çº¿/ito</h1>
        <div style="background: white; padding: 30px; border-radius: 12px;">
            <p>è¯·è¾“å…¥æ˜µç§°åŠ å…¥æ¸¸æˆ</p>
            <input type="text" id="username" placeholder="ä½ çš„æ˜µç§°" maxlength="10">
            <br><br>
            <button class="btn btn-blue" onclick="initLogin()">è¿›å…¥æˆ¿é—´</button>
        </div>
    </div>

    <div id="game-screen" class="container hidden">
        <div class="top-bar">
            <div style="text-align:left;">
                <div style="font-size:14px; color:#666;">ç”¨æˆ·: <strong id="my-name-display"></strong></div>
                <div style="font-size:12px; color:#999; margin-top:2px;">
                    <a href="javascript:doLogout()" style="color:#666;">é€€å‡ºç™»å½•</a>
                </div>
            </div>
            <button id="btn-emergency-reset" class="btn btn-red" style="font-size:12px; padding:5px 10px;" onclick="handleEmergencyReset()">âš  é‡ç½®æœ¬å±€</button>
        </div>

        <div class="game-layout">
            <div class="sidebar">
                <div class="player-box">
                    <h4>åœ¨çº¿ç©å®¶</h4>
                    <div id="player-list-container"></div>
                </div>

                <div id="chat-container">
                    <div id="chat-header" onclick="toggleChat()">
                        <span id="chat-toggle-icon">â–¼ æ”¶èµ·èŠå¤©</span>
                    </div>
                    
                    <div id="chat-messages">
                        <div class="chat-line" style="color:#999;">æ¬¢è¿è¿›å…¥èŠå¤©å®¤...</div>
                    </div>
                    <div class="chat-controls">
                        <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeydown="if(event.key==='Enter') sendChat()">
                        <button class="btn btn-blue" style="padding: 8px 15px; margin:0;" onclick="sendChat()">å‘é€</button>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div id="spectator-overlay">
                    âš  æ¸¸æˆæ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…æœ¬å±€ç»“æŸåè‡ªåŠ¨åŠ å…¥ã€‚<br>ç›®å‰æ‚¨åªèƒ½è§‚çœ‹å’ŒèŠå¤©ï¼Œ<b>æ— æ³•æ‹–åŠ¨ç‰Œ</b>ã€‚
                </div>

                <div class="theme-box">
                    <small>å½“å‰ä¸»é¢˜</small>
                    <div id="theme-display">...</div>
                    <div id="theme-controls">
                        <input type="text" id="theme-input" placeholder="è¾“å…¥æ–°é¢˜ç›®" style="width: 150px;">
                        <button id="btn-random-theme" class="btn btn-purple" onclick="requestRandomTheme()">ğŸ²</button>
                        <button id="btn-set-theme" class="btn btn-blue" onclick="trySetTheme()">è®¾ç½®</button>
                    </div>
                </div>

                <div id="my-hand-area" class="my-area hidden">
                    <div style="color: #666; font-size: 14px;">ä½ çš„æ•°å­— (ä»…è‡ªå·±å¯è§)</div>
                    <div id="my-number" class="card-number">?</div>
                    
                    <div class="desc-input-group" id="input-group">
                        <input type="text" id="my-desc-input" placeholder="è¾“å…¥æè¿° (å¦‚: è‹¹æœ)ï¼Œæœ€å¤š20å­—" maxlength="20">
                        <button class="btn btn-green" onclick="confirmDesc()">ç¡®å®š</button>
                    </div>
                    <div id="desc-display-group" class="hidden" style="margin-top:10px;">
                        <span style="font-size:18px; font-weight:bold; color: #1d3557;">æè¿°: <span id="my-desc-text"></span></span>
                        <button class="btn btn-red" style="padding: 5px 10px; font-size: 12px;" onclick="withdrawDesc()">æ’¤å›ä¿®æ”¹</button>
                    </div>

                    <div style="margin-top: 20px;">
                        <button id="btn-play" class="btn btn-blue" style="width: 100%; padding: 15px; font-size: 18px;" onclick="playCard()" disabled>æŠŠç‰Œæ‰“å…¥æ¡Œé¢</button>
                        <button id="btn-takeback" class="btn btn-gray hidden" style="width: 100%; margin-top:5px;" onclick="takeBackCard()">ä»æ¡Œé¢æ”¶å›</button>
                    </div>
                </div>

                <div class="table-area">
                    <div class="direction-line">
                        <span>0 (å°)</span>
                        <span>(å¤§) 100</span>
                    </div>

                    <h3>æ¡Œé¢ (æ‰€æœ‰äººå¯æ‹–åŠ¨æ’åº)</h3>
                    <div id="card-list"></div>
                    <div id="result-bar"></div>
                </div>

                <div style="margin-top: 30px; border-top: 1px solid #ddd; padding-top: 20px;">
                    <div class="mode-selector" id="mode-selector-area">
                        <div class="mode-item selected" onclick="selectMode('normal')">æ™®é€šæ¨¡å¼</div>
                        <div class="mode-item disabled">åŒç‰Œæ¨¡å¼</div>
                        <div class="mode-item disabled">ç‹¼äººæ¨¡å¼</div>
                    </div>

                    <div style="display: flex; justify-content: center; gap: 10px;">
                        <button id="btn-start" class="btn btn-green" onclick="handleStartGame()">å¼€å§‹æ¸¸æˆ</button>
                        <button id="btn-reveal" class="btn btn-red" onclick="tryRevealCards()" disabled>ğŸ‘‘ å¼€ç‰Œç»“ç®—</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({
            reconnection: true,
            reconnectionAttempts: Infinity
        });

        let myUid = localStorage.getItem('ito_uid');
        let myName = localStorage.getItem('ito_name');
        let myCurrentNumber = null;
        let isMyCardPlayed = false;
        let isSpectator = false;
        let currentStatus = 'waiting'; 
        let activePlayerCount = 0; 
        let tableCardCount = 0; 
        let sortableInstance = null;
        let toastTimeout = null;
        let selectedMode = 'normal';
        let resetClickCount = 0; 
        let afkTimer = null;
        const AFK_LIMIT = 5 * 60 * 1000;
        let isChatCollapsed = false;

        function toggleChat() {
            const container = document.getElementById('chat-container');
            const icon = document.getElementById('chat-toggle-icon');
            isChatCollapsed = !isChatCollapsed;
            
            if (isChatCollapsed) {
                container.classList.add('collapsed');
                icon.textContent = "â–² å±•å¼€èŠå¤©";
            } else {
                container.classList.remove('collapsed');
                icon.textContent = "â–¼ æ”¶èµ·èŠå¤©";
            }
        }

        function showModal(title, body, onConfirm, onCancel, showInput = false) {
            const overlay = document.getElementById('modal-overlay');
            const t = document.getElementById('modal-title');
            const b = document.getElementById('modal-body');
            const inp = document.getElementById('modal-input');
            const btnOk = document.getElementById('modal-btn-confirm');
            const btnCancel = document.getElementById('modal-btn-cancel');

            t.textContent = title;
            b.innerHTML = body;
            
            if (showInput) {
                inp.classList.remove('hidden');
                inp.value = "";
                inp.focus();
            } else {
                inp.classList.add('hidden');
            }

            btnOk.onclick = null;
            btnCancel.onclick = null;

            if (onCancel) {
                btnCancel.classList.remove('hidden');
                btnCancel.onclick = () => {
                    closeModal();
                    onCancel();
                };
            } else {
                btnCancel.classList.add('hidden');
            }

            btnOk.onclick = () => {
                const val = showInput ? inp.value : null;
                closeModal();
                if (onConfirm) onConfirm(val);
            };

            overlay.classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('show');
        }

        function customAlert(msg) {
            showModal("æç¤º", msg, null, null);
        }

        function customConfirm(msg, callback) {
            showModal("ç¡®è®¤", msg, callback, () => {}); 
        }

        function showPrompt(msg, callback) {
            showModal("è¯·è¾“å…¥", msg, callback, () => {}, true);
        }

        function resetAfkTimer() {
            if (afkTimer) clearTimeout(afkTimer);
            if (socket.connected && !document.getElementById('game-screen').classList.contains('hidden')) {
                afkTimer = setTimeout(() => {
                    socket.disconnect();
                    customAlert("æ‚¨å·²é•¿æ—¶é—´æœªæ“ä½œï¼Œå·²è‡ªåŠ¨ç¦»çº¿ã€‚è¯·åˆ·æ–°é¡µé¢é‡æ–°è¿æ¥ã€‚");
                }, AFK_LIMIT);
            }
        }

        ['mousemove', 'keydown', 'click', 'touchstart'].forEach(evt => {
            document.addEventListener(evt, resetAfkTimer);
        });

        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === 'visible') {
                if (!socket.connected) {
                    socket.connect();
                } else {
                    if(myUid && myName) socket.emit('login', { uid: myUid, name: myName });
                }
            }
        });

        socket.on('connect', () => {
            if (myUid && myName) {
                socket.emit('login', { uid: myUid, name: myName });
            }
            resetAfkTimer();
        });

        socket.on('disconnect', () => {
            document.getElementById('my-name-display').textContent = "è¿æ¥æ–­å¼€ï¼Œé‡è¿ä¸­...";
            if (afkTimer) clearTimeout(afkTimer);
        });

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function initLogin() {
            const nameInput = document.getElementById('username').value.trim();
            if (!nameInput) return customAlert("è¯·è¾“å…¥åå­—");
            
            if (!myUid) {
                myUid = generateUUID();
                localStorage.setItem('ito_uid', myUid);
            }
            myName = nameInput;
            localStorage.setItem('ito_name', myName);

            socket.emit('login', { uid: myUid, name: myName });
        }

        function doLogout() {
            localStorage.removeItem('ito_uid');
            localStorage.removeItem('ito_name');
            location.reload();
        }

        socket.on('loginSuccess', (data) => {
            const player = data.me;
            isSpectator = player.isSpectator;
            currentStatus = data.gameConfig.status;
            activePlayerCount = data.activePlayerCount;
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('my-name-display').textContent = player.name;
            document.getElementById('theme-display').textContent = data.gameConfig.theme;

            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML = ''; 
            data.chatHistory.forEach(msg => appendChat(msg));

            if (player.card) {
                myCurrentNumber = player.card;
                document.getElementById('my-number').textContent = player.card;
                document.getElementById('my-hand-area').classList.remove('hidden');
                
                if (player.desc) {
                    document.getElementById('my-desc-input').value = player.desc;
                    confirmDesc(false);
                }
                
                isMyCardPlayed = player.isPlayed;
                updateMyPlayArea();
            } else {
                document.getElementById('my-hand-area').classList.add('hidden');
            }

            renderTable(data.tableCards, currentStatus === 'revealed');
            toggleSpectatorMode(isSpectator);
            updateGameButtons();
            resetAfkTimer();
        });

        socket.on('updatePlayerList', (list) => {
            const container = document.getElementById('player-list-container');
            container.innerHTML = '';
            activePlayerCount = list.filter(p => !p.isSpectator && p.online).length;
            
            list.forEach(p => {
                const div = document.createElement('div');
                div.className = 'player-item';
                if (p.uid === myUid) div.classList.add('is-me');
                if (p.isPlayed) div.classList.add('done');
                if (!p.online) div.classList.add('offline'); 
                
                let statusText = p.isSpectator ? " (æ—è§‚)" : (p.isPlayed ? " âœ…" : "");
                if (!p.online) statusText += " (ç¦»çº¿)";
                
                div.textContent = p.name + statusText;
                container.appendChild(div);
            });
            updateGameButtons(); 
        });

        socket.on('updateTheme', (t) => { 
            document.getElementById('theme-display').textContent = t;
            showToast("æœ¬è½®æ¸¸æˆä¸»é¢˜å·²æ›´æ–°ï¼"); 
        });

        socket.on('errorMessage', (msg) => {
            customAlert(msg);
        });

        socket.on('gameStarted', (data) => {
            currentStatus = 'playing';
            activePlayerCount = data.activePlayerCount;
            
            document.getElementById('my-hand-area').classList.remove('hidden');
            document.getElementById('result-bar').style.display = 'none';
            
            isSpectator = false; 
            toggleSpectatorMode(false);
            
            resetMyUI();
            updateGameButtons();
        });
        
        socket.on('forceReset', () => {
             location.reload();
        });

        socket.on('yourCard', (data) => { 
            if (data.number === null) {
                myCurrentNumber = null;
                document.getElementById('my-number').textContent = "?";
                document.getElementById('my-hand-area').classList.add('hidden');
            } else {
                myCurrentNumber = data.number; 
                document.getElementById('my-number').textContent = data.number;
                document.getElementById('my-hand-area').classList.remove('hidden');
            }
        });

        socket.on('updateTable', (cards) => {
            tableCardCount = cards.length;
            renderTable(cards);
            updateGameButtons();
        });

        socket.on('playerPlayed', (uid) => {
            if (uid === myUid) {
                isMyCardPlayed = true;
                updateMyPlayArea();
            }
        });

        socket.on('playerTakenBack', (uid) => {
            if (uid === myUid) {
                isMyCardPlayed = false;
                updateMyPlayArea();
            }
        });

        socket.on('gameResult', (data) => {
            currentStatus = 'revealed';
            renderTable(data.tableCards, true, data.failedIndices);
            
            const bar = document.getElementById('result-bar');
            bar.style.display = 'block';
            bar.className = '';
            if (data.isSuccess) {
                bar.textContent = "ğŸ‰ æŒ‘æˆ˜æˆåŠŸï¼é¡ºåºå®Œç¾ï¼";
                bar.classList.add('result-success');
            } else {
                bar.textContent = "ğŸ’€ æŒ‘æˆ˜å¤±è´¥ï¼æ ‡çº¢çš„å¡ç‰‡é¡ºåºé”™äº†ã€‚";
                bar.classList.add('result-fail');
            }
            bar.scrollIntoView({ behavior: 'smooth' });
            updateGameButtons();
        });

        socket.on('gameEnded', () => {});

        socket.on('chatMessage', (msg) => { appendChat(msg); });

        function showToast(msg) {
            const toast = document.getElementById('toast-notification');
            if(msg) toast.textContent = msg;
            toast.classList.add('show');
            if (toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000); 
        }

        function toggleSpectatorMode(isSpec) {
            const overlay = document.getElementById('spectator-overlay');
            const handArea = document.getElementById('my-hand-area');
            const themeBtn = document.getElementById('btn-set-theme');
            const randomBtn = document.getElementById('btn-random-theme');
            const themeInput = document.getElementById('theme-input');
            
            if (isSpec) {
                overlay.style.display = 'block';
                handArea.classList.add('hidden');
                themeBtn.disabled = true;
                randomBtn.disabled = true;
                themeInput.disabled = true;
                document.getElementById('btn-start').disabled = true;
                document.getElementById('btn-reveal').disabled = true;
            } else {
                overlay.style.display = 'none';
            }
            const list = document.getElementById('card-list');
            if (list && sortableInstance) {
                sortableInstance.option("disabled", isSpec || currentStatus === 'revealed');
            }
        }

        function selectMode(mode) {
            if (mode !== 'normal') return; 
            selectedMode = mode;
            const items = document.querySelectorAll('.mode-item');
            items.forEach(el => el.classList.remove('selected'));
            items[0].classList.add('selected'); 
        }

        function updateGameButtons() {
            if (isSpectator) return; 

            const btnStart = document.getElementById('btn-start');
            const btnReveal = document.getElementById('btn-reveal');
            const modeArea = document.getElementById('mode-selector-area');
            
            const themeBtn = document.getElementById('btn-set-theme');
            const randomBtn = document.getElementById('btn-random-theme');
            const themeInput = document.getElementById('theme-input');

            if (currentStatus === 'playing') {
                btnStart.classList.add('hidden'); 
                modeArea.classList.add('hidden'); 
                
                if (tableCardCount > 0) {
                    themeBtn.disabled = true;
                    randomBtn.disabled = true;
                    themeInput.disabled = true;
                } else {
                    themeBtn.disabled = false;
                    randomBtn.disabled = false;
                    themeInput.disabled = false;
                }

            } else {
                btnStart.classList.remove('hidden');
                btnStart.textContent = "å¼€å§‹æ¸¸æˆ";
                modeArea.classList.remove('hidden');
                
                themeBtn.disabled = false;
                randomBtn.disabled = false;
                themeInput.disabled = false;
            }

            if (currentStatus === 'playing' && tableCardCount > 0 && tableCardCount >= activePlayerCount) {
                btnReveal.disabled = false;
            } else {
                btnReveal.disabled = true;
            }
        }

        function handleEmergencyReset() {
            if (isSpectator) {
                showPrompt("è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥å¼ºåˆ¶é‡ç½®æœ¬å±€ï¼š", (password) => {
                    if (password) {
                        socket.emit('emergencyReset', password);
                    }
                });
                return;
            }

            resetClickCount++;
            if (resetClickCount >= 2) {
                customConfirm("<b style='color:red'>ç¡®å®šè¦å¼ºåˆ¶é‡ç½®æ¸¸æˆå—ï¼Ÿ</b><br>è¿™å°†æ¸…ç©ºæ‰€æœ‰çŠ¶æ€ã€æ‰‹ç‰Œå’ŒèŠå¤©è®°å½•ã€‚", () => {
                    socket.emit('emergencyReset', null); 
                    resetClickCount = 0;
                });
            } else {
                showToast("å†ç‚¹å‡»ä¸€æ¬¡é‡ç½®æœ¬å±€æ¸¸æˆ"); 
                setTimeout(() => resetClickCount = 0, 3000);
            }
        }

        function requestRandomTheme() {
            if (isSpectator) return customAlert("æ—è§‚è€…æ— æ³•è®¾ç½®ä¸»é¢˜");
            if (currentStatus === 'playing' && tableCardCount > 0) return customAlert("å·²æœ‰ç‰Œæ‰“å‡ºï¼Œæ— æ³•ä¿®æ”¹ä¸»é¢˜");
            
            customConfirm("æ˜¯å¦ç¡®å®šéšæœºé€‰æ‹©ä¸€ä¸ªä¸»é¢˜ï¼Ÿ", () => {
                socket.emit('requestRandomTheme');
            });
        }

        function handleStartGame() {
            socket.emit('startGame', selectedMode);
        }

        function tryRevealCards() {
            if (tableCardCount < activePlayerCount) return;
            customConfirm("ç¡®å®šæ‰€æœ‰äººéƒ½å‡ºç‰Œå®Œæ¯•ï¼Œå¹¶ç¡®è®¤ç»“ç®—å—ï¼Ÿ", () => {
                socket.emit('revealCards');
            });
        }

        function trySetTheme() {
            const val = document.getElementById('theme-input').value.trim();
            if (!val) return;
            if (currentStatus === 'playing' && tableCardCount > 0) return customAlert("å·²æœ‰ç‰Œæ‰“å‡ºï¼Œæ— æ³•ä¿®æ”¹ä¸»é¢˜");

            customConfirm(`ç¡®å®šè¦å°†é¢˜ç›®ä¿®æ”¹ä¸ºï¼šâ€œ${escapeHtml(val)}â€ å—ï¼Ÿ`, () => {
                socket.emit('updateTheme', val);
            });
        }

        function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            if (myCurrentNumber !== null) {
                if (msg.includes(myCurrentNumber.toString())) {
                    customAlert(`ğŸš« ç¦æ­¢å‘é€ï¼æ¶ˆæ¯åŒ…å«æ‰‹ç‰Œæ•°å­— "${myCurrentNumber}"ã€‚`);
                    return;
                }
            }
            socket.emit('sendChat', { uid: myUid, msg: msg });
            input.value = '';
            resetAfkTimer(); 
        }

        function appendChat(data) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'chat-line';
            div.innerHTML = `<span class="name">${escapeHtml(data.name)}:</span> ${escapeHtml(data.msg)}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function confirmDesc(emit = true) {
            const val = document.getElementById('my-desc-input').value.trim();
            if (!val) return customAlert("è¯·è¾“å…¥æè¿°");
            const currentDesc = val; 
            
            document.getElementById('input-group').classList.add('hidden');
            document.getElementById('desc-display-group').classList.remove('hidden');
            document.getElementById('my-desc-text').textContent = currentDesc;
            
            document.getElementById('btn-play').disabled = false;
            if (emit) socket.emit('updateDesc', { uid: myUid, desc: currentDesc });
        }

        function withdrawDesc() {
            if (isMyCardPlayed) return customAlert("è¯·å…ˆæ”¶å›å¡ç‰Œ");
            document.getElementById('input-group').classList.remove('hidden');
            document.getElementById('desc-display-group').classList.add('hidden');
            document.getElementById('btn-play').disabled = true;
        }

        function playCard() { socket.emit('playCard', { uid: myUid }); }
        function takeBackCard() { socket.emit('takeBackCard', { uid: myUid }); }

        function updateMyPlayArea() {
            const btnPlay = document.getElementById('btn-play');
            const btnTake = document.getElementById('btn-takeback');
            if (isMyCardPlayed) {
                btnPlay.classList.add('hidden');
                btnTake.classList.remove('hidden');
            } else {
                btnPlay.classList.remove('hidden');
                btnTake.classList.add('hidden');
                btnPlay.disabled = false; 
            }
        }

        function resetMyUI() {
            document.getElementById('my-desc-input').value = "";
            isMyCardPlayed = false;
            myCurrentNumber = null;
            document.getElementById('input-group').classList.remove('hidden');
            document.getElementById('desc-display-group').classList.add('hidden');
            document.getElementById('btn-play').classList.remove('hidden');
            document.getElementById('btn-play').disabled = true;
            document.getElementById('btn-takeback').classList.add('hidden');
        }

        function renderTable(cards, isRevealed = false, failedIndices = []) {
            const list = document.getElementById('card-list');
            list.innerHTML = '';

            cards.forEach((c, index) => {
                const el = document.createElement('div');
                el.className = `game-card ${isRevealed ? 'flipped' : ''}`;
                
                if (c.uid === myUid) {
                    el.classList.add('is-mine');
                }

                if (!isRevealed && !isSpectator) {
                    el.classList.add('can-drag');
                }

                if (failedIndices.includes(index)) el.classList.add('error');
                el.setAttribute('data-uid', c.uid);

                const front = document.createElement('div');
                front.className = 'card-front';
                front.innerHTML = `<div class="owner-name">${c.name}</div><div class="card-desc">${c.desc || '...'}</div>`;

                const back = document.createElement('div');
                back.className = 'card-back';
                const displayNum = c.number !== null ? c.number : '?'; 
                back.innerHTML = `<small>${c.name}</small><div class="big-num">${displayNum}</div><div style="font-size:10px; margin-top:5px;">${c.desc}</div>`;

                const inner = document.createElement('div');
                inner.className = 'card-inner';
                inner.appendChild(front);
                inner.appendChild(back);
                el.appendChild(inner);
                list.appendChild(el);
            });

            if (!isRevealed) {
                if (!sortableInstance) {
                    sortableInstance = new Sortable(list, {
                        animation: 150,
                        ghostClass: 'dragging',
                        disabled: isSpectator, 
                        onEnd: function (evt) {
                            const newOrder = [];
                            const items = list.querySelectorAll('.game-card');
                            items.forEach(item => newOrder.push(item.getAttribute('data-uid')));
                            socket.emit('reorderCards', newOrder);
                        }
                    });
                } else {
                    sortableInstance.option("disabled", isSpectator);
                }
            } else {
                if (sortableInstance) sortableInstance.option("disabled", true);
            }
        }

        function escapeHtml(text) {
            if (!text) return text;
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
