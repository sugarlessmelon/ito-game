<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ito Online</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root { --primary: #1d3557; --accent: #e63946; --bg: #f0f2f5; --card-bg: #fff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); text-align: center; margin: 0; padding-bottom: 220px; }
        .container { max-width: 900px; margin: 0 auto; padding: 10px; }
        .hidden { display: none !important; }
        .btn { border: none; padding: 10px 15px; border-radius: 6px; font-size: 16px; cursor: pointer; color: white; transition: 0.2s; margin: 5px; touch-action: manipulation; }
        .btn-blue { background: #457b9d; }
        .btn-red { background: #e63946; }
        .btn-green { background: #2a9d8f; }
        .btn-gray { background: #6c757d; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; background: #999; }
        input { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }

        .game-layout { display: flex; gap: 20px; align-items: flex-start; }
        .main-content { flex: 1; width: 100%; }
        .sidebar { width: 120px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left; font-size: 14px; flex-shrink: 0; }
        .sidebar h4 { margin: 0 0 10px 0; color: var(--primary); font-size: 16px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .player-item { padding: 5px 0; color: #555; border-bottom: 1px solid #f0f0f0; }
        .player-item.is-me { color: var(--accent); font-weight: bold; }
        .player-item.done { color: #2a9d8f; }

        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .theme-box { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; position: relative; }
        #theme-display { font-size: 24px; font-weight: bold; color: var(--primary); margin: 10px 0; word-wrap: break-word; }
        
        .my-area { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; transition: 0.3s; }
        .card-number { font-size: 72px; font-weight: 800; color: var(--accent); line-height: 1; margin: 10px 0; }
        
        .table-area { min-height: 220px; background: #e9ecef; border-radius: 12px; padding: 20px; border: 2px dashed #cbd5e1; position: relative; }
        #card-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        
        .game-card { width: 100px; height: 140px; perspective: 1000px; position: relative; cursor: grab; touch-action: none; }
        .game-card:active { cursor: grabbing; }
        .game-card.dragging { opacity: 0.5; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s; transform-style: preserve-3d; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .game-card.flipped .card-inner { transform: rotateY(180deg); }
        .game-card.error .card-back { border: 4px solid #e63946; background: #fff0f0; }

        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 8px; padding: 5px; box-sizing: border-box; word-break: break-all; }
        .card-front { background: var(--primary); color: white; }
        .card-front .owner-name { font-size: 12px; opacity: 0.8; margin-bottom: 5px; }
        .card-front .card-desc { font-size: 14px; font-weight: bold; padding: 0 5px; }
        .card-back { background: white; color: var(--primary); transform: rotateY(180deg); border: 2px solid var(--primary); }
        .card-back .big-num { font-size: 40px; font-weight: bold; color: var(--accent); }
        .card-back small { font-size: 12px; color: #666; }

        #result-bar { margin-top: 15px; padding: 15px; border-radius: 8px; font-size: 18px; font-weight: bold; display: none; }
        .result-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .result-fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        #spectator-overlay { padding: 20px; background: #fff3cd; color: #856404; border: 1px solid #ffeeba; border-radius: 8px; margin-bottom: 20px; display: none; }

        #chat-container { position: fixed; bottom: 0; left: 0; right: 0; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); padding: 10px; max-width: 900px; margin: 0 auto; z-index: 99; border-top-left-radius: 12px; border-top-right-radius: 12px; }
        #chat-messages { height: 120px; overflow-y: auto; border: 1px solid #eee; margin-bottom: 10px; padding: 5px; text-align: left; background: #f9f9f9; border-radius: 6px; font-size: 14px; }
        .chat-line { margin-bottom: 4px; border-bottom: 1px solid #eee; padding-bottom: 2px;}
        .chat-line .name { font-weight: bold; color: #457b9d; }
        .chat-controls { display: flex; gap: 5px; }
        #chat-input { flex-grow: 1; }

        @media(max-width: 600px) {
            .game-layout { flex-direction: column-reverse; }
            .sidebar { width: 100%; box-sizing: border-box; text-align: center; }
            .player-item { display: inline-block; margin-right: 10px; }
            .game-card { width: 80px; height: 110px; }
            .card-front .card-desc { font-size: 12px; }
            body { padding-bottom: 200px; }
        }
    </style>
</head>
<body>
    <div id="login-screen" class="container">
        <h1>ito Online</h1>
        <div style="background: white; padding: 30px; border-radius: 12px;">
            <p>è¯·è¾“å…¥æ˜µç§°åŠ å…¥æ¸¸æˆ</p>
            <input type="text" id="username" placeholder="ä½ çš„æ˜µç§°" maxlength="10">
            <br><br>
            <button class="btn btn-blue" onclick="initLogin()">è¿›å…¥æˆ¿é—´</button>
        </div>
    </div>

    <div id="game-screen" class="container hidden">
        <div class="top-bar">
            <div style="font-size:14px; color:#666;">ç”¨æˆ·: <strong id="my-name-display"></strong></div>
            <button class="btn btn-gray" style="font-size:12px; padding:5px 10px;" onclick="doLogout()">é€€å‡ºç™»å½•</button>
        </div>

        <div class="game-layout">
            <div class="sidebar">
                <h4>åœ¨çº¿ç©å®¶</h4>
                <div id="player-list-container"></div>
            </div>

            <div class="main-content">
                <div id="spectator-overlay">
                    âš  æ¸¸æˆæ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…æœ¬å±€ç»“æŸåè‡ªåŠ¨åŠ å…¥ã€‚<br>ç›®å‰æ‚¨åªèƒ½è§‚çœ‹å’ŒèŠå¤©ã€‚
                </div>

                <div class="theme-box">
                    <small>å½“å‰ä¸»é¢˜</small>
                    <div id="theme-display">...</div>
                    <div id="theme-controls">
                        <input type="text" id="theme-input" placeholder="è¾“å…¥æ–°é¢˜ç›®" style="width: 150px;">
                        <button class="btn btn-blue" onclick="trySetTheme()">è®¾ç½®é¢˜ç›®</button>
                    </div>
                </div>

                <div id="my-hand-area" class="my-area hidden">
                    <div style="color: #666; font-size: 14px;">ä½ çš„æ•°å­— (ä»…è‡ªå·±å¯è§)</div>
                    <div id="my-number" class="card-number">?</div>
                    
                    <div class="desc-input-group" id="input-group">
                        <input type="text" id="my-desc-input" placeholder="è¾“å…¥æè¿° (å¦‚: è‹¹æœ)" maxlength="15">
                        <button class="btn btn-green" onclick="confirmDesc()">ç¡®å®š</button>
                    </div>
                    <div id="desc-display-group" class="hidden" style="margin-top:10px;">
                        <span style="font-size:18px; font-weight:bold; color: #1d3557;">æè¿°: <span id="my-desc-text"></span></span>
                        <button class="btn btn-red" style="padding: 5px 10px; font-size: 12px;" onclick="withdrawDesc()">æ’¤å›ä¿®æ”¹</button>
                    </div>

                    <div style="margin-top: 20px;">
                        <button id="btn-play" class="btn btn-blue" style="width: 100%; padding: 15px; font-size: 18px;" onclick="playCard()" disabled>æŠŠç‰Œæ‰“å…¥æ¡Œé¢</button>
                        <button id="btn-takeback" class="btn btn-gray hidden" style="width: 100%; margin-top:5px;" onclick="takeBackCard()">ä»æ¡Œé¢æ”¶å›</button>
                    </div>
                </div>

                <div class="table-area">
                    <h3>æ¡Œé¢ (æ‰€æœ‰äººå¯æ‹–åŠ¨æ’åº)</h3>
                    <div id="card-list"></div>
                    <div id="result-bar"></div>
                </div>

                <div style="margin-top: 30px; border-top: 1px solid #ddd; padding-top: 20px;">
                    <div style="display: flex; justify-content: center; gap: 10px;">
                        <button id="btn-main-action" class="btn btn-green" onclick="handleMainAction()">å¼€å§‹æ¸¸æˆ</button>
                        <button id="btn-reveal" class="btn btn-red" onclick="tryRevealCards()" disabled>ğŸ‘‘ å¼€ç‰Œç»“ç®—</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="chat-container" class="hidden">
        <div id="chat-messages">
            <div class="chat-line" style="color:#999;">æ¬¢è¿è¿›å…¥èŠå¤©å®¤...</div>
        </div>
        <div class="chat-controls">
            <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeydown="if(event.key==='Enter') sendChat()">
            <button class="btn btn-blue" style="padding: 8px 15px; margin:0;" onclick="sendChat()">å‘é€</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({
            reconnection: true,
            reconnectionAttempts: Infinity
        });

        let myUid = localStorage.getItem('ito_uid');
        let myName = localStorage.getItem('ito_name');
        let myCurrentNumber = null;
        let isMyCardPlayed = false;
        let isSpectator = false;
        let currentStatus = 'waiting'; 
        let activePlayerCount = 0; 
        let tableCardCount = 0; 
        let sortableInstance = null;

        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === 'visible') {
                if (!socket.connected) {
                    socket.connect();
                } else {
                    if(myUid && myName) socket.emit('login', { uid: myUid, name: myName });
                }
            }
        });

        socket.on('connect', () => {
            if (myUid && myName) {
                socket.emit('login', { uid: myUid, name: myName });
            }
        });

        socket.on('disconnect', () => {
            document.getElementById('my-name-display').textContent = "è¿æ¥æ–­å¼€ï¼Œé‡è¿ä¸­...";
        });

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function initLogin() {
            const nameInput = document.getElementById('username').value.trim();
            if (!nameInput) return alert("è¯·è¾“å…¥åå­—");
            
            if (!myUid) {
                myUid = generateUUID();
                localStorage.setItem('ito_uid', myUid);
            }
            myName = nameInput;
            localStorage.setItem('ito_name', myName);

            socket.emit('login', { uid: myUid, name: myName });
        }

        function doLogout() {
            localStorage.removeItem('ito_uid');
            localStorage.removeItem('ito_name');
            location.reload();
        }

        socket.on('loginSuccess', (data) => {
            const player = data.me;
            isSpectator = player.isSpectator;
            currentStatus = data.gameConfig.status;
            activePlayerCount = data.activePlayerCount;
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('chat-container').classList.remove('hidden');
            document.getElementById('my-name-display').textContent = player.name;
            document.getElementById('theme-display').textContent = data.gameConfig.theme;

            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML = ''; 
            data.chatHistory.forEach(msg => appendChat(msg));

            if (player.card) {
                myCurrentNumber = player.card;
                document.getElementById('my-number').textContent = player.card;
                if (player.desc) {
                    document.getElementById('my-desc-input').value = player.desc;
                    confirmDesc(false);
                }
            }

            renderTable(data.tableCards, currentStatus === 'revealed');
            toggleSpectatorMode(isSpectator);
            updateGameButtons();
        });

        socket.on('updatePlayerList', (list) => {
            const container = document.getElementById('player-list-container');
            container.innerHTML = '';
            activePlayerCount = list.filter(p => !p.isSpectator).length;
            
            list.forEach(p => {
                const div = document.createElement('div');
                div.className = 'player-item';
                if (p.uid === myUid) div.classList.add('is-me');
                if (p.isPlayed) div.classList.add('done');
                
                let statusText = p.isSpectator ? " (æ—è§‚)" : (p.isPlayed ? " âœ…" : "");
                div.textContent = p.name + statusText;
                container.appendChild(div);
            });
            updateGameButtons(); 
        });

        socket.on('updateTheme', (t) => { document.getElementById('theme-display').textContent = t; });

        socket.on('gameStarted', (data) => {
            currentStatus = 'playing';
            activePlayerCount = data.activePlayerCount;
            
            document.getElementById('my-hand-area').classList.remove('hidden');
            document.getElementById('result-bar').style.display = 'none';
            
            isSpectator = false; 
            toggleSpectatorMode(false);
            
            resetMyUI();
            updateGameButtons();
        });

        socket.on('yourCard', (data) => { 
            myCurrentNumber = data.number; 
            document.getElementById('my-number').textContent = data.number; 
        });

        socket.on('updateTable', (cards) => {
            tableCardCount = cards.length;
            renderTable(cards);
            updateGameButtons();
        });

        socket.on('playerPlayed', (uid) => {
            if (uid === myUid) {
                isMyCardPlayed = true;
                updateMyPlayArea();
            }
        });

        socket.on('playerTakenBack', (uid) => {
            if (uid === myUid) {
                isMyCardPlayed = false;
                updateMyPlayArea();
            }
        });

        socket.on('gameResult', (data) => {
            currentStatus = 'revealed';
            renderTable(data.tableCards, true, data.failedIndices);
            
            const bar = document.getElementById('result-bar');
            bar.style.display = 'block';
            bar.className = '';
            if (data.isSuccess) {
                bar.textContent = "ğŸ‰ æŒ‘æˆ˜æˆåŠŸï¼é¡ºåºå®Œç¾ï¼";
                bar.classList.add('result-success');
            } else {
                bar.textContent = "ğŸ’€ æŒ‘æˆ˜å¤±è´¥ï¼æ ‡çº¢çš„å¡ç‰‡é¡ºåºé”™äº†ã€‚";
                bar.classList.add('result-fail');
            }
            bar.scrollIntoView({ behavior: 'smooth' });
            updateGameButtons();
        });

        socket.on('gameEnded', () => {});

        socket.on('chatMessage', (msg) => { appendChat(msg); });

        function toggleSpectatorMode(isSpec) {
            const overlay = document.getElementById('spectator-overlay');
            const handArea = document.getElementById('my-hand-area');
            const themeBtn = document.querySelector('#theme-controls button');
            const themeInput = document.querySelector('#theme-controls input');
            
            if (isSpec) {
                overlay.style.display = 'block';
                handArea.classList.add('hidden');
                themeBtn.disabled = true;
                themeInput.disabled = true;
                document.getElementById('btn-main-action').disabled = true;
                document.getElementById('btn-reveal').disabled = true;
            } else {
                overlay.style.display = 'none';
                themeBtn.disabled = false;
                themeInput.disabled = false;
            }
        }

        function updateGameButtons() {
            if (isSpectator) return; 

            const btnMain = document.getElementById('btn-main-action');
            const btnReveal = document.getElementById('btn-reveal');

            if (currentStatus === 'playing') {
                btnMain.textContent = "é‡æ–°å¼€å§‹æœ¬å±€";
                btnMain.className = "btn btn-gray"; 
            } else {
                btnMain.textContent = "å¼€å§‹æ¸¸æˆ";
                btnMain.className = "btn btn-green";
            }

            if (currentStatus === 'playing' && tableCardCount > 0 && tableCardCount === activePlayerCount) {
                btnReveal.disabled = false;
            } else {
                btnReveal.disabled = true;
            }
        }

        function handleMainAction() {
            if (currentStatus === 'playing') {
                if (confirm("âš ï¸ è­¦å‘Šï¼šå½“å‰æ¸¸æˆæ­£åœ¨è¿›è¡Œä¸­ã€‚\nç¡®å®šè¦ä¸­æ–­å¹¶é‡æ–°å¼€å§‹æœ¬å±€å—ï¼Ÿ")) {
                    socket.emit('startGame', true);
                }
            } else {
                socket.emit('startGame', false);
            }
        }

        function tryRevealCards() {
            if (tableCardCount !== activePlayerCount) return;
            socket.emit('revealCards');
        }

        function trySetTheme() {
            const val = document.getElementById('theme-input').value.trim();
            if (!val) return;
            if (confirm(`ç¡®å®šè¦å°†é¢˜ç›®ä¿®æ”¹ä¸ºï¼šâ€œ${val}â€ å—ï¼Ÿ`)) {
                socket.emit('updateTheme', val);
            }
        }

        // --- ä¿®å¤ç¡®è®¤ï¼šèŠå¤©ä¸è¾“å…¥æ£€æµ‹ ---
        function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            // æ£€æŸ¥é€»è¾‘
            if (myCurrentNumber !== null) {
                if (msg.includes(myCurrentNumber.toString())) {
                    alert(`ğŸš« ç¦æ­¢å‘é€ï¼æ¶ˆæ¯åŒ…å«æ‰‹ç‰Œæ•°å­— "${myCurrentNumber}"ã€‚`);
                    return;
                }
            }
            socket.emit('sendChat', { uid: myUid, msg: msg });
            input.value = '';
        }

        function appendChat(data) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'chat-line';
            div.innerHTML = `<span class="name">${escapeHtml(data.name)}:</span> ${escapeHtml(data.msg)}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function confirmDesc(emit = true) {
            const val = document.getElementById('my-desc-input').value.trim();
            if (!val) return alert("è¯·è¾“å…¥æè¿°");
            const currentDesc = val; 
            
            document.getElementById('input-group').classList.add('hidden');
            document.getElementById('desc-display-group').classList.remove('hidden');
            document.getElementById('my-desc-text').textContent = currentDesc;
            
            document.getElementById('btn-play').disabled = false;
            if (emit) socket.emit('updateDesc', { uid: myUid, desc: currentDesc });
        }

        function withdrawDesc() {
            if (isMyCardPlayed) return alert("è¯·å…ˆæ”¶å›å¡ç‰Œ");
            document.getElementById('input-group').classList.remove('hidden');
            document.getElementById('desc-display-group').classList.add('hidden');
            document.getElementById('btn-play').disabled = true;
        }

        function playCard() { socket.emit('playCard', { uid: myUid }); }
        function takeBackCard() { socket.emit('takeBackCard', { uid: myUid }); }

        function updateMyPlayArea() {
            const btnPlay = document.getElementById('btn-play');
            const btnTake = document.getElementById('btn-takeback');
            if (isMyCardPlayed) {
                btnPlay.classList.add('hidden');
                btnTake.classList.remove('hidden');
            } else {
                btnPlay.classList.remove('hidden');
                btnTake.classList.add('hidden');
                btnPlay.disabled = false; 
            }
        }

        function resetMyUI() {
            document.getElementById('my-desc-input').value = "";
            isMyCardPlayed = false;
            myCurrentNumber = null;
            document.getElementById('input-group').classList.remove('hidden');
            document.getElementById('desc-display-group').classList.add('hidden');
            document.getElementById('btn-play').classList.remove('hidden');
            document.getElementById('btn-play').disabled = true;
            document.getElementById('btn-takeback').classList.add('hidden');
        }

        function renderTable(cards, isRevealed = false, failedIndices = []) {
            const list = document.getElementById('card-list');
            list.innerHTML = '';

            cards.forEach((c, index) => {
                const el = document.createElement('div');
                el.className = `game-card ${isRevealed ? 'flipped' : ''}`;
                if (failedIndices.includes(index)) el.classList.add('error');
                el.setAttribute('data-uid', c.uid);

                const front = document.createElement('div');
                front.className = 'card-front';
                front.innerHTML = `<div class="owner-name">${c.name}</div><div class="card-desc">${c.desc || '...'}</div>`;

                const back = document.createElement('div');
                back.className = 'card-back';
                const displayNum = c.number !== null ? c.number : '?'; 
                back.innerHTML = `<small>${c.name}</small><div class="big-num">${displayNum}</div><div style="font-size:10px; margin-top:5px;">${c.desc}</div>`;

                const inner = document.createElement('div');
                inner.className = 'card-inner';
                inner.appendChild(front);
                inner.appendChild(back);
                el.appendChild(inner);
                list.appendChild(el);
            });

            if (!isRevealed) {
                if (!sortableInstance) {
                    sortableInstance = new Sortable(list, {
                        animation: 150,
                        ghostClass: 'dragging',
                        onEnd: function (evt) {
                            const newOrder = [];
                            const items = list.querySelectorAll('.game-card');
                            items.forEach(item => newOrder.push(item.getAttribute('data-uid')));
                            socket.emit('reorderCards', newOrder);
                        }
                    });
                } else {
                    sortableInstance.option("disabled", false);
                }
            } else {
                if (sortableInstance) sortableInstance.option("disabled", true);
            }
        }

        function escapeHtml(text) {
            if (!text) return text;
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
