<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ¨çº¿ ito - èŠå¤©å‡çº§ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root { --primary: #1d3557; --accent: #e63946; --bg: #f1faee; --card-bg: #fff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; text-align: center; padding: 10px; margin: 0; padding-bottom: 200px; /* ç»™åº•éƒ¨èŠå¤©æ¡†ç•™ä½ç½® */ }
        .container { max-width: 800px; margin: 0 auto; }
        
        .hidden { display: none !important; }
        .btn { border: none; padding: 10px 15px; border-radius: 6px; font-size: 16px; cursor: pointer; color: white; transition: 0.2s; margin: 5px; }
        .btn-blue { background: #457b9d; }
        .btn-red { background: #e63946; }
        .btn-green { background: #2a9d8f; }
        .btn-gray { background: #6c757d; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        input { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }

        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .user-info { font-size: 14px; color: #666; }
        .theme-box { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        #theme-display { font-size: 24px; font-weight: bold; color: var(--primary); margin: 10px 0; }

        .my-area { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-number { font-size: 72px; font-weight: 800; color: var(--accent); line-height: 1; margin: 10px 0; }
        .desc-input-group { display: flex; gap: 5px; justify-content: center; margin-top: 10px; }
        
        .table-area { min-height: 200px; background: #e9ecef; border-radius: 12px; padding: 20px; border: 2px dashed #cbd5e1; position: relative; }
        #card-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        
        .game-card { width: 100px; height: 140px; perspective: 1000px; position: relative; touch-action: none; }
        .draggable-item { cursor: grab; }
        .draggable-item:active { cursor: grabbing; }
        .locked-item { cursor: not-allowed; opacity: 0.9; }
        .game-card.dragging { opacity: 0.5; }
        
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s; transform-style: preserve-3d; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .game-card.flipped .card-inner { transform: rotateY(180deg); }
        .game-card.error .card-back { border: 4px solid #e63946; background: #fff0f0; }

        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 8px; padding: 5px; box-sizing: border-box; word-break: break-all; }
        .card-front { background: var(--primary); color: white; }
        .card-front .owner-name { font-size: 12px; opacity: 0.8; margin-bottom: 5px; }
        .card-front .card-desc { font-size: 14px; font-weight: bold; padding: 0 5px; }
        .card-back { background: white; color: var(--primary); transform: rotateY(180deg); border: 2px solid var(--primary); }
        .card-back .big-num { font-size: 40px; font-weight: bold; color: var(--accent); }
        .card-back small { font-size: 12px; color: #666; }

        @media(max-width: 600px) {
            .game-card { width: 80px; height: 110px; }
            .card-front .card-desc { font-size: 12px; }
        }

        /* --- æ–°å¢æ ·å¼ï¼šç»“æœæ¡ --- */
        #result-bar {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            display: none; /* é»˜è®¤éšè— */
        }
        .result-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .result-fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* --- æ–°å¢æ ·å¼ï¼šèŠå¤©æ¡† --- */
        #chat-container {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 10px;
            max-width: 800px;
            margin: 0 auto;
            z-index: 99;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        #chat-messages {
            height: 100px;
            overflow-y: auto;
            border: 1px solid #eee;
            margin-bottom: 10px;
            padding: 5px;
            text-align: left;
            background: #f9f9f9;
            border-radius: 6px;
            font-size: 14px;
        }
        .chat-line { margin-bottom: 4px; }
        .chat-line .name { font-weight: bold; color: #457b9d; }
        .chat-line .msg { color: #333; }
        .chat-controls { display: flex; gap: 5px; }
        #chat-input { flex-grow: 1; padding: 8px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div id="login-screen" class="container">
        <h1>ito Online</h1>
        <div style="background: white; padding: 30px; border-radius: 12px;">
            <p>è¯·è¾“å…¥æ˜µç§°åŠ å…¥æ¸¸æˆ</p>
            <input type="text" id="username" placeholder="ä½ çš„æ˜µç§°" maxlength="10">
            <br><br>
            <button class="btn btn-blue" onclick="doLogin()">è¿›å…¥æˆ¿é—´</button>
        </div>
    </div>

    <div id="game-screen" class="container hidden">
        <div class="top-bar">
            <div class="user-info">ç©å®¶: <span id="my-name-display"></span></div>
            <button class="btn btn-gray" style="font-size:12px; padding:5px 10px;" onclick="doLogout()">é€€å‡º/æ¢å·</button>
        </div>

        <div class="theme-box">
            <small>å½“å‰ä¸»é¢˜</small>
            <div id="theme-display">...</div>
            <div id="theme-controls">
                <input type="text" id="theme-input" placeholder="è¾“å…¥æ–°é¢˜ç›®" style="width: 150px;">
                <button class="btn btn-blue" onclick="setTheme()">è®¾ç½®é¢˜ç›®</button>
            </div>
        </div>

        <div id="my-hand-area" class="my-area hidden">
            <div style="color: #666; font-size: 14px;">ä½ çš„æ•°å­— (ä»…è‡ªå·±å¯è§)</div>
            <div id="my-number" class="card-number">?</div>
            <div class="desc-input-group" id="input-group">
                <input type="text" id="my-desc-input" placeholder="è¾“å…¥æè¿° (å¦‚: è‹¹æœ)" maxlength="15">
                <button class="btn btn-green" onclick="confirmDesc()">ç¡®å®š</button>
            </div>
            <div id="desc-display-group" class="hidden" style="margin-top:10px;">
                <span style="font-size:18px; font-weight:bold; color: #1d3557;">æè¿°: <span id="my-desc-text"></span></span>
                <button class="btn btn-red" style="padding: 5px 10px; font-size: 12px;" onclick="withdrawDesc()">æ’¤å›ä¿®æ”¹</button>
            </div>
            <div style="margin-top: 20px;">
                <button id="btn-play" class="btn btn-blue" style="width: 100%; padding: 15px; font-size: 18px;" onclick="playCard()" disabled>æŠŠç‰Œæ‰“å…¥æ¡Œé¢</button>
                <button id="btn-takeback" class="btn btn-gray hidden" style="width: 100%; margin-top:5px;" onclick="takeBackCard()">ä»æ¡Œé¢æ”¶å›</button>
            </div>
        </div>

        <div class="table-area">
            <h3>æ¡Œé¢ (åªèƒ½æ‹–åŠ¨è‡ªå·±çš„ç‰Œ)</h3>
            <div id="card-list"></div>
            
            <div id="result-bar"></div>
        </div>

        <div style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 20px;">
            <p id="status-text" style="color:#666; margin-bottom:10px;">ç­‰å¾…æ“ä½œ...</p>
            <div style="display: flex; justify-content: center; gap: 10px;">
                <button class="btn btn-green" onclick="socket.emit('startGame')">é‡æ–°å‘ç‰Œ/ä¸‹ä¸€å±€</button>
                <button class="btn btn-red" onclick="revealCards()">ğŸ‘‘ å¼€ç‰Œç»“ç®—</button>
            </div>
            <br>
            <button class="btn btn-gray" onclick="socket.emit('resetGame')">é‡ç½®ä¸€åˆ‡</button>
        </div>
        
        <div style="margin-top: 20px; font-size: 12px; color: #999;">
            åœ¨çº¿ç©å®¶: <span id="player-list-span"></span>
        </div>
    </div>

    <div id="chat-container" class="hidden">
        <div id="chat-messages">
            <div class="chat-line" style="color:#999; font-style:italic;">æ¬¢è¿è¿›å…¥èŠå¤©å®¤ï¼Œè¯·å‹¿å‘é€æ‰‹ç‰Œæ•°å­—...</div>
        </div>
        <div class="chat-controls">
            <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeydown="if(event.key==='Enter') sendChat()">
            <button class="btn btn-blue" style="padding: 8px 15px; margin:0;" onclick="sendChat()">å‘é€</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myUid = localStorage.getItem('ito_uid');
        let myName = localStorage.getItem('ito_name');
        let currentDesc = "";
        let isMyCardPlayed = false;
        let sortableInstance = null;
        
        // --- æ–°å¢ï¼šå­˜å‚¨å½“å‰æ•°å­—ç”¨äºæ£€æµ‹ ---
        let myCurrentNumber = null;

        if (myUid && myName) {
            document.getElementById('username').value = myName;
            doLogin();
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function doLogin() {
            const nameInput = document.getElementById('username').value.trim();
            if (!nameInput) return alert("è¯·è¾“å…¥åå­—");
            
            if (!myUid) {
                myUid = generateUUID();
                localStorage.setItem('ito_uid', myUid);
            }
            myName = nameInput;
            localStorage.setItem('ito_name', myName);

            socket.emit('login', { uid: myUid, name: myName });
        }

        function doLogout() {
            localStorage.removeItem('ito_uid');
            localStorage.removeItem('ito_name');
            location.reload();
        }

        // --- Socket ç›‘å¬ ---

        socket.on('loginSuccess', (player) => {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('chat-container').classList.remove('hidden'); // æ˜¾ç¤ºèŠå¤©æ¡†
            document.getElementById('my-name-display').textContent = player.name;
            if (player.card) {
                myCurrentNumber = player.card; // æ¢å¤æ•°å­—
                document.getElementById('my-hand-area').classList.remove('hidden');
                document.getElementById('my-number').textContent = player.card;
                if (player.desc) {
                    document.getElementById('my-desc-input').value = player.desc;
                    confirmDesc(false);
                }
            }
        });

        socket.on('updateTheme', (t) => { document.getElementById('theme-display').textContent = t; });
        
        socket.on('gameStarted', () => {
            document.getElementById('my-hand-area').classList.remove('hidden');
            document.getElementById('status-text').textContent = "æ¸¸æˆå¼€å§‹ï¼è¯·æ€è€ƒå¹¶å¡«å†™æè¿°ã€‚";
            document.getElementById('result-bar').style.display = 'none'; // éšè—ä¸Šæ¬¡ç»“æœ
            resetMyUI();
        });
        
        socket.on('yourCard', (data) => { 
            document.getElementById('my-number').textContent = data.number; 
            myCurrentNumber = data.number; // å­˜å‚¨æ•°å­—ç”¨äºèŠå¤©æ£€æµ‹
        });
        
        socket.on('updatePlayerList', (list) => { document.getElementById('player-list-span').textContent = list.map(p => p.name).join(', '); });
        socket.on('updateTable', (cards) => { renderTable(cards); });
        
        socket.on('playerPlayed', (uid) => {
            if (uid === myUid) {
                isMyCardPlayed = true;
                updatePlayButtonState();
            }
        });
        
        socket.on('playerTakenBack', (uid) => {
            if (uid === myUid) {
                isMyCardPlayed = false;
                updatePlayButtonState();
            }
        });

        // --- ä¿®æ”¹ï¼šç»“æœå±•ç¤ºé€»è¾‘ ---
        socket.on('gameResult', (data) => {
            renderTable(data.tableCards, true, data.failedIndices);
            
            // æ˜¾ç¤ºç»“æœæ¡
            const bar = document.getElementById('result-bar');
            bar.style.display = 'block';
            bar.className = ''; // æ¸…ç©ºæ—§ç±»
            
            if (data.isSuccess) {
                bar.textContent = "ğŸ‰ æŒ‘æˆ˜æˆåŠŸï¼æ’åºå®Œç¾æ— ç¼ºï¼";
                bar.classList.add('result-success');
            } else {
                bar.textContent = "ğŸ’€ æŒ‘æˆ˜å¤±è´¥ï¼æ ‡çº¢çš„å¡ç‰‡é¡ºåºé”™äº†ã€‚";
                bar.classList.add('result-fail');
            }
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°ç»“æœå¤„
            bar.scrollIntoView({ behavior: 'smooth' });
        });

        socket.on('resetGame', () => {
            document.getElementById('my-hand-area').classList.add('hidden');
            document.getElementById('card-list').innerHTML = '';
            document.getElementById('theme-display').textContent = "ç­‰å¾…è®¾ç½®...";
            document.getElementById('result-bar').style.display = 'none';
            myCurrentNumber = null; // æ¸…ç©ºæ•°å­—
            resetMyUI();
        });

        // --- æ–°å¢ï¼šèŠå¤©æ¥æ”¶ ---
        socket.on('chatMessage', (data) => {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'chat-line';
            div.innerHTML = `<span class="name">${data.name}:</span> <span class="msg">${escapeHtml(data.msg)}</span>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight; // æ»šåŠ¨åˆ°åº•éƒ¨
        });

        // --- äº¤äº’é€»è¾‘ ---

        function setTheme() {
            const val = document.getElementById('theme-input').value;
            if(val) socket.emit('updateTheme', val);
        }

        function confirmDesc(emit = true) {
            const val = document.getElementById('my-desc-input').value.trim();
            if (!val) return alert("è¯·è¾“å…¥æè¿°");
            currentDesc = val;
            document.getElementById('input-group').classList.add('hidden');
            document.getElementById('desc-display-group').classList.remove('hidden');
            document.getElementById('my-desc-text').textContent = currentDesc;
            document.getElementById('btn-play').disabled = false;
            if (emit) socket.emit('updateDesc', { uid: myUid, desc: currentDesc });
        }

        function withdrawDesc() {
            if (isMyCardPlayed) return alert("è¯·å…ˆä»æ¡Œé¢æ”¶å›å¡ç‰Œå†ä¿®æ”¹æè¿°");
            document.getElementById('input-group').classList.remove('hidden');
            document.getElementById('desc-display-group').classList.add('hidden');
            document.getElementById('btn-play').disabled = true;
        }

        function playCard() { if (currentDesc) socket.emit('playCard', { uid: myUid }); }
        function takeBackCard() { socket.emit('takeBackCard', { uid: myUid }); }
        function revealCards() { if(confirm("ç¡®å®šæ‰€æœ‰äººéƒ½å‡ºå®Œå¹¶æ’å¥½åºäº†å—ï¼Ÿ")) socket.emit('revealCards'); }

        // --- æ–°å¢ï¼šå‘é€èŠå¤©é€»è¾‘ ---
        function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            
            if (!msg) return;

            // è§„åˆ™æ£€æµ‹ï¼šå¦‚æœæ‰‹ä¸Šæœ‰ç‰Œï¼Œä¸”æ¶ˆæ¯é‡ŒåŒ…å«è¿™ä¸ªæ•°å­—
            if (myCurrentNumber !== null) {
                const numStr = myCurrentNumber.toString();
                if (msg.includes(numStr)) {
                    alert(`ğŸš« ç¦æ­¢å‘é€ï¼\nä½ çš„æ¶ˆæ¯é‡ŒåŒ…å«äº†ä½ æ‰‹ä¸Šçš„æ•°å­— "${numStr}"ã€‚\nè¯·éµå®ˆæ¸¸æˆè§„åˆ™ï¼`);
                    return; // é˜»æ­¢å‘é€
                }
            }

            socket.emit('sendChat', { uid: myUid, msg: msg });
            input.value = ''; // æ¸…ç©º
        }

        function updatePlayButtonState() {
            const btnPlay = document.getElementById('btn-play');
            const btnTake = document.getElementById('btn-takeback');
            if (isMyCardPlayed) {
                btnPlay.classList.add('hidden');
                btnTake.classList.remove('hidden');
            } else {
                btnPlay.classList.remove('hidden');
                btnTake.classList.add('hidden');
                btnPlay.disabled = !currentDesc;
            }
        }

        function resetMyUI() {
            document.getElementById('my-desc-input').value = "";
            currentDesc = "";
            isMyCardPlayed = false;
            document.getElementById('input-group').classList.remove('hidden');
            document.getElementById('desc-display-group').classList.add('hidden');
            document.getElementById('btn-play').disabled = true;
            document.getElementById('btn-play').classList.remove('hidden');
            document.getElementById('btn-takeback').classList.add('hidden');
        }

        function renderTable(cards, isRevealed = false, failedIndices = []) {
            const list = document.getElementById('card-list');
            list.innerHTML = '';

            cards.forEach((c, index) => {
                const el = document.createElement('div');
                const isMine = c.uid === myUid; 
                el.className = `game-card ${isRevealed ? 'flipped' : ''}`;
                if (!isRevealed) {
                    el.classList.add(isMine ? 'draggable-item' : 'locked-item');
                }
                if (failedIndices.includes(index)) el.classList.add('error');
                el.setAttribute('data-uid', c.uid);

                const front = document.createElement('div');
                front.className = 'card-front';
                front.innerHTML = `<div class="owner-name">${c.name}</div><div class="card-desc">${c.desc || '...'}</div>`;

                const back = document.createElement('div');
                back.className = 'card-back';
                const displayNum = c.number !== null ? c.number : '?'; 
                back.innerHTML = `<small>${c.name}</small><div class="big-num">${displayNum}</div><div style="font-size:10px; margin-top:5px;">${c.desc}</div>`;

                const inner = document.createElement('div');
                inner.className = 'card-inner';
                inner.appendChild(front);
                inner.appendChild(back);
                el.appendChild(inner);
                list.appendChild(el);
            });

            if (!isRevealed) {
                if (!sortableInstance) {
                    sortableInstance = new Sortable(list, {
                        animation: 150,
                        ghostClass: 'dragging',
                        draggable: ".draggable-item", 
                        onEnd: function (evt) {
                            const newOrder = [];
                            const items = list.querySelectorAll('.game-card');
                            items.forEach(item => newOrder.push(item.getAttribute('data-uid')));
                            socket.emit('reorderCards', newOrder);
                        }
                    });
                } else {
                    sortableInstance.option("disabled", false);
                    sortableInstance.option("draggable", ".draggable-item");
                }
            } else {
                if (sortableInstance) sortableInstance.option("disabled", true);
            }
        }
        
        // ç®€å•é˜²XSS
        function escapeHtml(text) {
            if (!text) return text;
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
